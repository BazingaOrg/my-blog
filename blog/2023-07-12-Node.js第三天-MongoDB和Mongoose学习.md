---
slug: Node.js第三天-MongoDB和Mongoose学习
title: MongoDB和Mongoose学习
authors: Bazinga
tags: [MongoDB, Mongoose, node.js]
---
### 一、MongoDB学习

1. 创建或切换名称为 natours-test 的数据库

   ```javascript
   use natours-test
   ```

2. 在当前所在数据库中的 tours 集合中插入一条或多条数据

   ```javascript
   db.tours.insertOne({ name: "The forest hiker", price: 297, rating: 4.7 })
   
   db.tours.insertMany([{ name: "The forest hiker", price: 297, rating: 4.7 }, { name: "The skater", price: 999, rating: 5.0, difficulty: 'easy' }])
   ```

3. 在当前所在数据库中的 tours 集合中查找 name 是 xx 、price 小于500、rating 大于等于4.8的数据（与运算）

   ```javascript
   db.tours.find({ name: "xxx", price: { $lt: 500 }, rating: { $gte: 4.8 } })
   ```

4. 在当前所在数据库中的 tours 集合中查找 price 小于500 或 rating 大于等于 4.8 的数据中的 name（或运算）

   ```javascript
   db.tours.find({ $or: [ { price: { $lt: 500 } }, { rating: { $gte: 4.8 } } ] }, { name: 1 })
   ```

5. 在当前所在数据库中的 tours 集合中查找 rating 是 4.7 的数据并将rating 更新为5.0、price 更新为 999

   ```javascript
   db.tours.updateOne({ rating: 4.7 }, { $set: { rating: 5.0, price: 999 } })
   ```

6. 在当前所在数据库中的 tours 集合中查找 price 小于500、rating 大于等于4.8的数据并批量新增premium字段设置为true

   ```javascript
   db.tours.updateMany({ price: { $lt: 500 }, rating: { $gte: 4.8 } }, { $set: { premium: true } })
   ```

7. 在当前所在数据库中的 tours 集合中删除一条或多条 rating 大于等于 4.8 的数据

   ```javascript
   db.tours.deleteOne({ rating: { $gte: 4.8 } })
   
   db.tours.deleteMany({ rating: { $gte: 4.8 } })
   ```


### 二、Mongoose学习

```javascript
const mongoose = require('mongoose');
const dotenv = require('dotenv');
dotenv.config({ path: './config.env' });

const DB = process.env.DATABASE.replace(
  '<password>',
  process.env.DATABASE_PASSWORD,
);  //  来自MongoDB Atlas：DATABASE=mongodb+srv://Bazinga:<password>@tours.f2sads6.mongodb.net/?retryWrites=true&w=majority

// 连接MongoDB
mongoose.connect(DB, {
    useNewUrlParser: true,
    useCreateIndex: true,
    useFindAndModify: false,
}).then(con => {
    console.log(con.connections);
    console.log('MongoDB connects successfully!');
};

// 创建数据模型(这里可以在项目里新建一个models文件夹，用去存放用到的各种数据模型)
const tourSchema = new mongoose.Schema({
  name: {
    type: String,
    required: [true, 'Name must be provided'],
    unique: true,
  },
  rating: {
    type: Number,
    default: 4.5,
  },
  price: {
    type: Number,
    required: [true, 'Price must be provided'],
  },
});

const Tour = mongoose.model('Tour', tourSchema);
const testTour = new Tour({
  name: 'testtest',
  price: 999,
  rating: 4.5,
});
testTour
  .save()
  .then((doc) => console.log(doc))
  .catch((err) => console.log(err));
```